#!/usr/bin/env bash
#
# Bootstrap packages (install packages)

set -e

echo ""

function info() {
  echo -e "\n  \e[1;35m==>\e[0m $1 ℹ\n"
}

function success() {
  echo -e "\n\e[2K  \e[0;32m==>\e[0m $1 ✅\n"
}

function fail() {
  echo -e "\n\e[2K  \e[0;31m==>\e[0m $1 ❌\n"
  echo ''
  exit 1
}

info 'Update and upgrade packages from official source.list'
sudo apt update && sudo apt full-upgrade -y
success 'Upgraded successfully'

# install homebrew if it's not installed otherwise update brew
if hash brew 2>/dev/null; then
  info 'Update brew formulas'
  brew update
  success 'Formulas updated'
else
  info 'Install homebrew (linuxbrew)'
  CI=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
  success 'Homebrew (linuxbrew) installed successfully'
fi

info 'Install homebrew build dependencies and add brew to PATH'
sudo apt install build-essential -y
[ -d "/home/linuxbrew/.linuxbrew" ] &&
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# make homebrew available in non-sudo installs
[ -d "$HOME/.linuxbrew" ] &&
  eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
success 'brew added to PATH and brew build dependencies installed successfully'

# Installing stuff
info 'Installing all fun stuff ...'

# Upgrade any already-installed formulae.
brew upgrade

# Install yarn
hash node 2>/dev/null &&
  ! hash yarn 2>/dev/null &&
  curl -o- -L https://yarnpkg.com/install.sh | bash

# Install packages with brew
if [ -s "$HOME/Brewfile" ]; then
  brew bundle --file="$HOME/Brewfile" -v
else
  fail "Brewfile not found on home directory."
fi
success 'All stuff installed and already up-to-date'

# Remove outdated versions from the cellar.
info 'Cleanup outdated versions from brew cellar.'
brew cleanup

# Install OMZ if .oh-my-zsh directory not already in home
[ ! -d "$HOME/.oh-my-zsh" ] &&
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" \
  "" --unattended --keep-zshrc

# Switch default shell to zsh from brew
BREW_PREFIX=$(brew --prefix)
if ! grep -q "$BREW_PREFIX/bin/zsh" /etc/shells; then
  info 'Make zsh installed from brew to default shell'
  echo "$BREW_PREFIX/bin/zsh" | sudo tee -a /etc/shells
  chsh -s "$BREW_PREFIX/bin/zsh"
  success 'Changed to zsh shell from brew installed zsh'
fi

success 'All done!'
